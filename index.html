<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>金馬鴻運聚福堂 - 崇正寶宮靈籤</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel CDN -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- html2canvas CDN -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&display=swap');
        
        :root {
            --wood-base: #a52a2a;
            --wood-dark: #5d1a1a;
            --gold-glow: #fbbf24;
        }

        body {
            font-family: 'Noto Serif TC', serif;
            margin: 0;
            padding: 0;
            background-color: #2d0a0a;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .gate-perspective {
            perspective: 2000px;
            overflow: hidden;
        }

        @keyframes swing-left {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(-115deg); }
        }
        @keyframes swing-right {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(115deg); }
        }
        
        .animate-swing-left { 
            transform-origin: left;
            animation: swing-left 2.8s cubic-bezier(0.4, 0, 0.2, 1) forwards; 
        }
        .animate-swing-right { 
            transform-origin: right;
            animation: swing-right 2.8s cubic-bezier(0.4, 0, 0.2, 1) forwards; 
        }

        @keyframes float {
            0% { transform: translate(0, 0); }
            50% { transform: translate(10px, -15px); }
            100% { transform: translate(0, 0); }
        }
        .animate-float {
            animation: float 6s ease-in-out infinite;
        }
        
        ::-webkit-scrollbar { display: none; }

        .paper-texture {
            background-image: url("https://www.transparenttextures.com/patterns/paper-fibers.png");
        }

        .wood-texture {
            background-color: var(--wood-base);
            background-image: repeating-linear-gradient(
                90deg,
                rgba(0,0,0,0.2) 0px,
                rgba(0,0,0,0.2) 2px,
                transparent 2px,
                transparent 50px,
                rgba(255,255,255,0.05) 50px,
                rgba(255,255,255,0.05) 52px
            );
            box-shadow: inset 0 0 120px rgba(0,0,0,0.7);
        }

        .seal-font {
            font-size: 28px;
            font-weight: 900;
            line-height: 1;
            letter-spacing: 0.05em;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 子組件定義 ---
        const IconChevronLeft = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-9-6 9-6"/></svg>
        );
        const IconSparkles = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3 1.912 5.813a2 2 0 0 0 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 0-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 0-1.275-1.275L3 12l5.813-1.912a2 2 0 0 0 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
        );
        const IconVolume2 = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M11 5 6 9H2v6h4l5 4V5Z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
        );
        const IconVolumeX = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M11 5 6 9H2v6h4l5 4V5Z"/><line x1="22" y1="9" x2="16" y2="15"/><line x1="16" y1="9" x2="22" y2="15"/></svg>
        );

        const MountainLogo = ({ className }) => (
            <img 
                src="assets/白陽山LOGO.jpg" 
                alt="白陽山" 
                className={className} 
                style={{ objectFit: 'contain' }}
                loading="eager"
                crossOrigin="anonymous"
                onError={(e) => { e.target.style.opacity = 0; }}
            />
        );

        const CloudImage = ({ className, style }) => (
            <img 
                src="assets/cloud.png" 
                alt="雲朵" 
                className={className} 
                style={{ objectFit: 'contain', mixBlendMode: 'screen', ...style }} 
            />
        );

        const JustifiedText = ({ text, className, style }) => {
            if (!text) return null;
            return (
                <div 
                    className={`text-left tracking-widest leading-normal select-none ${className}`} 
                    style={{ ...style }}
                >
                    {text}
                </div>
            );
        };

        const MuteButton = ({ isMuted, toggleMusic }) => (
            <button onClick={toggleMusic} className="fixed top-4 right-4 z-[200] p-2 bg-black/30 rounded-full text-amber-400 hover:bg-black/50 transition-colors shadow-lg">
                {isMuted ? <IconVolumeX /> : <IconVolume2 />}
            </button>
        );

        const GateHalf = ({ side }) => {
            const studs = Array(6).fill(0);
            return (
                <div className={`w-1/2 h-full wood-texture border-y-8 border-black relative flex items-center shadow-[inset_0_0_80px_rgba(0,0,0,0.8)] ${side === 'left' ? 'animate-swing-left justify-end border-r-2 border-r-black/50' : 'animate-swing-right justify-start border-l-2 border-l-black/50'}`}>
                    <div className="absolute inset-y-0 w-full bg-gradient-to-r from-black/20 via-transparent to-black/20 pointer-events-none" />
                    <div className={`absolute inset-0 flex items-center ${side === 'left' ? 'justify-start pl-8 md:pl-16' : 'justify-end pr-8 md:pr-16'}`}>
                        <div className="grid grid-cols-2 grid-rows-3 gap-x-6 gap-y-12 md:gap-x-12 md:gap-y-20 opacity-90">
                            {studs.map((_, i) => <div key={i} className="gate-stud" />)}
                        </div>
                    </div>
                    <div className={`relative flex items-center justify-center ${side === 'left' ? 'mr-[-40px]' : 'ml-[-40px]'} z-20`}>
                        <div className="w-20 h-20 md:w-24 md:h-24 rounded-full bg-red-700 border-4 border-amber-500 shadow-[0_0_20px_rgba(0,0,0,0.6)] flex items-center justify-center relative">
                            <div className="w-16 h-16 md:w-20 md:h-20 rounded-full border border-amber-600/50 shadow-inner" />
                            <div className="absolute inset-2 rounded-full bg-gradient-to-br from-white/10 to-transparent pointer-events-none" />
                        </div>
                    </div>
                </div>
            );
        };

        // --- 易經數據基礎 ---
        const hexagramsBase = [
          { id: 1, name: "乾", symbol: "天", lucky: "大展宏圖", text: "元亨利貞。大哉乾元，萬物資始，乃統天。雲行雨施，品物流形。" },
          { id: 2, name: "坤", symbol: "地", lucky: "厚德載物", text: "元亨，利牝馬之貞。君子有攸往，先迷後得主。" },
          { id: 3, name: "屯", symbol: "水雷", lucky: "好事多磨", text: "元亨利貞，勿用有攸往，利建侯。" },
          { id: 4, name: "蒙", symbol: "山水", lucky: "啟蒙開智", text: "亨。匪我求童蒙，童蒙求我。" },
          { id: 5, name: "需", symbol: "水天", lucky: "時機成熟", text: "有孚，光亨，貞吉。利涉大川。" },
          { id: 6, name: "訟", symbol: "天水", lucky: "止爭息訟", text: "有孚，窒惕，中吉，終凶.利見大人，不利涉大川。" },
          { id: 7, name: "師", symbol: "地水", lucky: "馬到成功", text: "貞，丈人，吉，无咎。" },
          { id: 8, name: "比", symbol: "水地", lucky: "貴人相助", text: "吉。原筮，元永貞，无咎。不寧方來，後夫凶。" },
          { id: 9, name: "小畜", symbol: "風天", lucky: "小有斬獲", text: "亨。密雲不雨，自我西郊。" },
          { id: 10, name: "履", symbol: "天澤", lucky: "有驚無險", text: "履虎尾，不咥人，亨。" },
          { id: 11, name: "泰", symbol: "地天", lucky: "否極泰來", text: "小往大來，吉亨。" },
          { id: 12, name: "否", symbol: "天地", lucky: "謹言慎行", text: "否之匪人，不利君子貞，大往小來。" },
          { id: 13, name: "同人", symbol: "天火", lucky: "同心協力", text: "同人於野，亨。利涉大川，利君子貞。" },
          { id: 14, name: "大有", symbol: "火天", lucky: "大豐收時", text: "元亨。" },
          { id: 15, name: "謙", symbol: "地山", lucky: "謙受益也", text: "亨，君子有終。" },
          { id: 16, name: "豫", symbol: "雷地", lucky: "愉悅順心", text: "利建侯行師。" },
          { id: 63, name: "既濟", symbol: "水火", lucky: "功德圓滿", text: "亨，小利貞，初吉終亂。" },
          { id: 64, name: "未濟", symbol: "火水", lucky: "重新出發", text: "亨，小狐汔濟，濡其尾，无攸利。" }
        ];

        const fortuneData = {};
        for (let i = 1; i <= 64; i++) {
            const base = hexagramsBase.find(h => h.id === i) || {
                name: "周易", lucky: "吉祥如意", text: "道法自然，心誠則靈。"
            };
            const textLines = base.text.split(/[。！？]/).filter(t => t.trim().length > 0);
            fortuneData[i] = {
                name: base.name,
                lucky: base.lucky,
                textLines: textLines
            };
        }

        const App = () => {
            const [page, setPage] = useState('home');
            const [lotNumber, setLotNumber] = useState('');
            const [currentDate, setCurrentDate] = useState('');
            const [isMuted, setIsMuted] = useState(false);
            
            const audioRef = useRef(null);
            const doorAudioRef = useRef(null);
            const cardRef = useRef(null);

            useEffect(() => {
                const today = new Date();
                setCurrentDate(`${today.getFullYear()}年${today.getMonth() + 1}月${today.getDate()}日`);
                audioRef.current = new Audio('assets/bgm.mp3');
                audioRef.current.loop = true;
                doorAudioRef.current = new Audio('https://assets.mixkit.co/active_storage/sfx/2177/2177-preview.mp3');

                const urlParams = new URLSearchParams(window.location.search);
                const lotParam = urlParams.get('lot');
                if (lotParam && fortuneData[lotParam]) {
                    setLotNumber(lotParam);
                    setPage('result');
                }

                const playOnFirstInteraction = () => {
                    if (audioRef.current && !isMuted) audioRef.current.play().catch(() => {});
                    window.removeEventListener('mousedown', playOnFirstInteraction);
                };
                window.addEventListener('mousedown', playOnFirstInteraction);
                return () => {
                    if (audioRef.current) audioRef.current.pause();
                    window.removeEventListener('mousedown', playOnFirstInteraction);
                };
            }, []);

            const toggleMusic = () => {
                if (!audioRef.current) return;
                isMuted ? audioRef.current.play() : audioRef.current.pause();
                setIsMuted(!isMuted);
            };

            const handleStart = () => {
                const num = parseInt(lotNumber);
                if (!lotNumber || isNaN(num) || num < 1 || num > 64) return;
                if (audioRef.current && !isMuted) audioRef.current.play().catch(() => {});
                setPage('door');
                if (doorAudioRef.current) {
                    doorAudioRef.current.currentTime = 0;
                    doorAudioRef.current.play().catch(() => {});
                }
                setTimeout(() => setPage('result'), 2800);
            };

            if (page === 'home') {
                return (
                    <div className="min-h-screen bg-[#2d0a0a] text-stone-200 flex flex-col items-center justify-center p-6 relative overflow-hidden">
                        <MuteButton isMuted={isMuted} toggleMusic={toggleMusic} />
                        <CloudImage className="absolute top-[-5%] left-[-8%] w-[24rem] opacity-40 animate-float" />
                        <CloudImage className="absolute top-1/4 right-[-5%] w-[10rem] opacity-25 animate-float" style={{ animationDelay: '-1.5s' }} />
                        <CloudImage className="absolute top-1/2 left-[-12%] w-[16rem] opacity-35 animate-float" style={{ animationDelay: '-3s' }} />
                        <CloudImage className="absolute bottom-[-2%] right-[-5%] w-[14rem] opacity-45 animate-float" style={{ animationDelay: '-4.8s' }} />

                        <div className="text-center z-10 w-full max-w-lg px-4">
                            <div className="mb-8 md:mb-12">
                                <h2 className="text-amber-500 text-xs md:text-sm tracking-[0.4em] font-medium mb-3 uppercase text-nowrap">Gold Horse Fortune</h2>
                                <h1 className="text-5xl md:text-8xl font-black mb-2 drop-shadow-2xl tracking-tighter text-nowrap bg-clip-text text-transparent bg-gradient-to-b from-[#fde68a] via-[#fbbf24] to-[#991b1b]">金馬鴻運</h1>
                                <h2 className="text-4xl md:text-5xl font-bold text-amber-500 tracking-widest text-nowrap">聚福堂</h2>
                            </div>
                            <div className="relative mt-8 group">
                                <div className="absolute -top-4 left-1/2 -translate-x-1/2 bg-[#5d1a1a] border border-amber-600/50 px-5 py-1 rounded-full z-20 shadow-lg text-nowrap">
                                    <span className="text-amber-200 text-xs md:text-sm tracking-widest font-medium">誠心祈求 - 易經指引</span>
                                </div>
                                <div className="bg-gradient-to-b from-amber-900/40 to-black/60 p-5 md:p-8 rounded-2xl border border-amber-500/30 shadow-[0_0_50px_rgba(251,191,36,0.15)] backdrop-blur-md">
                                    <div className="bg-black/50 border border-amber-500/50 rounded-lg p-3 mb-6">
                                        <input
                                            type="number"
                                            inputMode="numeric"
                                            value={lotNumber}
                                            onChange={(e) => setLotNumber(e.target.value)}
                                            placeholder="卦號 (1-64)"
                                            className="w-full bg-transparent text-center text-3xl md:text-5xl text-stone-300 focus:outline-none py-2"
                                        />
                                    </div>
                                    <button onClick={handleStart} className="w-full bg-gradient-to-b from-[#e68a00] to-[#b35900] text-white py-4 rounded-xl shadow-xl flex items-center justify-center gap-3 active:scale-95 transition-all">
                                        <IconSparkles className="text-amber-100" />
                                        <span className="text-lg md:text-xl font-bold tracking-[0.2em]">開啟鴻運</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (page === 'door') {
                return (
                    <div className="fixed inset-0 bg-black flex z-[100] gate-perspective text-nowrap">
                        <GateHalf side="left" />
                        <GateHalf side="right" />
                        <div className="absolute inset-0 bg-[#f4f3ed] flex items-center justify-center -z-10">
                            <div className="text-amber-600 text-2xl md:text-3xl font-bold animate-pulse tracking-widest">卦意顯現...</div>
                        </div>
                    </div>
                );
            }

            if (page === 'result') {
                const hexData = fortuneData[parseInt(lotNumber).toString()] || { name: "易", lucky: "大吉", textLines: ["心誠則靈"] };
                return (
                    <div className="min-h-screen bg-[#f4f3ed] flex flex-col items-center justify-center p-4 relative overflow-hidden">
                        <MuteButton isMuted={isMuted} toggleMusic={toggleMusic} />
                        
                        <div className="w-full absolute top-6 left-6 z-50">
                            <button onClick={() => setPage('home')} className="flex items-center text-red-900 text-sm font-bold p-3 bg-white/80 rounded-full shadow-md active:scale-95 transition-transform text-nowrap">
                                <IconChevronLeft className="mr-1" /> 重返聚福堂
                            </button>
                        </div>

                        <div className="flex-1 flex items-center justify-center w-full mt-10 mb-10 overflow-hidden">
                            <div ref={cardRef} data-card-body className="relative w-full max-w-[340px] md:max-w-[420px] h-fit max-h-[82vh] rounded-[24px] md:rounded-[32px] overflow-hidden shadow-2xl border border-stone-200 flex flex-col bg-white">
                                <div className="card-top bg-[#a52a2a] p-4 md:p-6 pt-5 pb-4 flex flex-col items-center relative overflow-hidden shrink-0">
                                    <CloudImage className="absolute top-1 left-[-10%] w-24 opacity-30 animate-float" />
                                    <CloudImage className="absolute top-2 right-10 w-20 opacity-20 animate-float" />
                                    <span className="text-[10px] text-white/60 tracking-[0.2em] font-bold mb-4 uppercase text-nowrap relative z-10">Fortune Card</span>
                                    <div className="logo-circle w-16 h-16 md:w-22 md:h-22 bg-[#fff9ea] rounded-full border-4 border-[#e9d5a1] flex items-center justify-center mb-4 shadow-inner p-3 overflow-hidden relative z-10">
                                        <MountainLogo className="w-full h-full" />
                                    </div>
                                    <div className="title-section w-full text-center space-y-1 px-8 mb-2 relative z-10">
                                        <h2 className="text-xl md:text-3xl font-black text-white tracking-[0.1em] text-nowrap">{hexData.name}卦</h2>
                                        <h2 className="text-lg md:text-2xl font-black text-amber-400 tracking-[0.2em] text-nowrap">{hexData.lucky}</h2>
                                    </div>
                                </div>
                                <div className="card-bottom p-6 pb-10 flex flex-col items-center relative text-stone-800 paper-texture overflow-hidden flex-1 overflow-y-auto">
                                    <div className="text-[10px] text-red-800 font-bold mb-6 tracking-[0.2em] opacity-80 uppercase text-center text-nowrap text-nowrap">
                                        — 崇正寶宮 易經第 {parseInt(lotNumber)} 卦 —
                                    </div>
                                    <div className="poetry-box bg-[#fdfaf2] border-l-4 border-amber-800 rounded-r-lg p-6 mb-6 text-stone-800 shadow-sm font-bold w-full">
                                        <div className="flex flex-col gap-6 w-full max-w-[300px] mx-auto py-2">
                                            {hexData.textLines.map((line, i) => (
                                                <JustifiedText 
                                                    key={i} 
                                                    text={line} 
                                                    className="text-[25px] md:text-[30px] text-red-950 leading-relaxed text-left" 
                                                />
                                            ))}
                                        </div>
                                    </div>
                                    <div className="card-footer w-full flex justify-between items-end mt-auto pt-6 px-1">
                                        <div className="auth-date-group flex flex-col gap-1 text-stone-900">
                                            <span className="text-[10px] text-amber-800 font-bold opacity-50 uppercase tracking-tighter text-nowrap">Auth Date</span>
                                            <span className="auth-date-text text-sm md:text-base font-black text-nowrap">{currentDate}</span>
                                        </div>
                                        <div className="card-seal w-14 h-14 md:w-20 md:h-20 bg-red-700 rounded-sm shadow-md transform rotate-1 border border-white/20 grid grid-cols-2 grid-rows-2 place-items-center text-white seal-font p-1">
                                            <div className="flex items-center justify-center">崇</div>
                                            <div className="flex items-center justify-center">正</div>
                                            <div className="flex items-center justify-center">寶</div>
                                            <div className="flex items-center justify-center">宮</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
